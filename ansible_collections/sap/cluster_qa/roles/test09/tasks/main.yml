---
- name: Clean-up of cluster
  ansible.builtin.shell: |-
    set -o pipefail |
    pcs resource cleanup
  run_once: true

- name: Collect necessary gather_facts
  ansible.builtin.setup:
    gather_subset:
      - min

- name: Finding ASCS node name
  ansible.builtin.include_role:
    name: sap.cluster_qa.pcs_find_ascs

- name: Store original ASCS node name before any modifications
  ansible.builtin.set_fact:
    sap_ascs_node_name_original: "{{ sap_ascs_node_name }}"

# ============================================================================
# PREREQUISITE VERIFICATION - FAIL EARLY IF NOT CONFIGURED
# ============================================================================

- name: Check if ASCS profile file exists
  ansible.builtin.stat:
    path: "{{ __pcs_find_ascs_sap_ascs_start_profile.stdout }}"
  register: profile_file_stat
  run_once: true
  delegate_to: "{{ sap_ascs_node_name }}"

- name: Check for Restart_Program parameter in ASCS profile
  ansible.builtin.shell: |
    grep "Restart_Program" "{{ __pcs_find_ascs_sap_ascs_start_profile.stdout }}" | grep "_MS" || echo "NOT_FOUND"
  register: restart_program_check
  changed_when: false
  run_once: true
  delegate_to: "{{ sap_ascs_node_name }}"
  when: profile_file_stat.stat.exists

- name: Verify Restart_Program parameter is configured for Message Server
  ansible.builtin.assert:
    that:
      - profile_file_stat.stat.exists
      - restart_program_check.stdout != "NOT_FOUND"
      - restart_program_check.stdout | length > 0
    fail_msg: |
      PREREQUISITE FAILED: Restart_Program parameter for Message Server not found in ASCS profile.
      Profile checked: {{ __pcs_find_ascs_sap_ascs_start_profile.stdout }}
      Profile exists: {{ profile_file_stat.stat.exists | default(false) }}

      Please manually configure it according to: https://help.sap.com/docs/SUPPORT_CONTENT/si/3362959619.html

      Expected configuration format:
      _MS = ms.sap$(SAPSYSTEMNAME)_$(INSTANCE_NAME)
      Restart_Program_00 = local $(_MS) pf=$(_PF)

      Or the expanded form:
      Restart_Program_00 = local ms.sapSYSTEMNAME_INSTANCENAME pf=/path/to/profile

      TEST WILL STOP HERE - Fix the configuration and re-run the test.
    success_msg: |
      ✓ PREREQUISITE VERIFIED: Restart_Program parameter found for Message Server.
      Configuration: {{ restart_program_check.stdout }}
      ✓ Proceeding with Message Server kill test...
  run_once: true

# ============================================================================
# MAIN TEST LOGIC - ALL TASKS BELOW ASSUME RESTART_PROGRAM IS CONFIGURED
# ============================================================================

- name: Finding ERS node name
  ansible.builtin.include_role:
    name: sap.cluster_qa.pcs_find_ers

- name: Setting initial facts
  ansible.builtin.set_fact:
    sap_ascs_node_name_initial: "{{ sap_ascs_node_name }}"
    sap_ers_node_name_initial: "{{ sap_ers_node_name }}"
    message_server_kill_count: 0
    max_kill_attempts: 6
    msg_server_restarted: true

- name: Verify ASCS and ERS are on different nodes initially
  ansible.builtin.assert:
    that: sap_ascs_node_name_initial != sap_ers_node_name_initial
    fail_msg: "ASCS and ERS are on the same node initially, which violates HA setup requirements"
    success_msg: "ASCS on {{ sap_ascs_node_name_initial }}, ERS on {{ sap_ers_node_name_initial }} - proper HA setup confirmed"

- name: Execute Message Server kill attempts
  include_tasks: kill_message_server.yml
  loop: "{{ range(1, max_kill_attempts|int + 1)|list }}"
  loop_control:
    loop_var: kill_attempt
  when: msg_server_restarted | bool

- name: Wait for HA solution to respond to unrecoverable Message Server failure
  ansible.builtin.pause:
    seconds: 60
    prompt: "Waiting for HA solution to respond to repeated Message Server failures"

- name: Check final ASCS location after HA intervention
  ansible.builtin.include_role:
    name: sap.cluster_qa.pcs_find_ascs

- name: Check final ERS location
  ansible.builtin.include_role:
    name: sap.cluster_qa.pcs_find_ers

- name: Set final location facts
  ansible.builtin.set_fact:
    sap_ascs_node_name_final: "{{ sap_ascs_node_name }}"
    sap_ers_node_name_final: "{{ sap_ers_node_name }}"

- name: Verify HA solution responded appropriately
  ansible.builtin.assert:
    that:
      - sap_ascs_node_name_final != sap_ers_node_name_final
    fail_msg: "HA solution failed: ASCS and ERS ended up on the same node ({{ sap_ascs_node_name_final }})"
    success_msg: "HA solution succeeded: ASCS on {{ sap_ascs_node_name_final }}, ERS on {{ sap_ers_node_name_final }}"

- name: Display test summary
  ansible.builtin.debug:
    msg: 
      - "==============================================="
      - "              TEST09 SUMMARY"
      - "==============================================="
      - "Message Server killed: {{ message_server_kill_count }} times"
      - "Initial ASCS location: {{ sap_ascs_node_name_initial }}"
      - "Final ASCS location: {{ sap_ascs_node_name_final }}"
      - "Initial ERS location: {{ sap_ers_node_name_initial }}"
      - "Final ERS location: {{ sap_ers_node_name_final }}"
      - "HA Action taken: {{ 'ASCS Failover' if sap_ascs_node_name_initial != sap_ascs_node_name_final else 'ASCS Restart on same node' }}"
      - "ASCS/ERS separation maintained: {{ 'YES' if sap_ascs_node_name_final != sap_ers_node_name_final else 'NO' }}"
      - "==============================================="
  run_once: true
