---
- name: Clean-up of cluster
  ansible.builtin.shell: |-
    set -o pipefail |
    pcs resource cleanup
  run_once: true

- name: Collect necessary gather_facts
  ansible.builtin.setup:
    gather_subset:
      - min

- name: Finding ASCS node name
  ansible.builtin.include_role:
    name: sap.cluster_qa.pcs_find_ascs

- name: Store original ASCS node name before any modifications
  ansible.builtin.set_fact:
    sap_ascs_node_name_original: "{{ sap_ascs_node_name }}"

- name: Check if ASCS profile file exists
  ansible.builtin.stat:
    path: "{{ __pcs_find_ascs_sap_ascs_start_profile.stdout }}"
  register: profile_file_stat
  run_once: true
  delegate_to: "{{ sap_ascs_node_name }}"

- name: Check for Restart_Program parameter in ASCS profile
  ansible.builtin.shell: |
    grep "Restart_Program" "{{ __pcs_find_ascs_sap_ascs_start_profile.stdout }}" | grep "_MS" || echo "NOT_FOUND"
  register: restart_program_check
  changed_when: false
  run_once: true
  delegate_to: "{{ sap_ascs_node_name }}"
  when: profile_file_stat.stat.exists

- name: Debug profile path and restart program search
  ansible.builtin.debug:
    msg: |
      Debug information:
      - Profile path: {{ __pcs_find_ascs_sap_ascs_start_profile.stdout }}
      - Profile file exists: {{ profile_file_stat.stat.exists | default(false) }}
      - Restart_Program search result: {{ restart_program_check.stdout | default("SKIPPED") }}
      - Search return code: {{ restart_program_check.rc | default("N/A") }}
  run_once: true

- name: Display Restart_Program configuration status
  ansible.builtin.debug:
    msg: |
      Restart_Program parameter check:
      - Profile path: {{ __pcs_find_ascs_sap_ascs_start_profile.stdout }}
      - Found Restart_Program for message server: {{ restart_program_check.stdout != "NOT_FOUND" and restart_program_check.stdout | length > 0 }}
      {% if restart_program_check.stdout != "NOT_FOUND" and restart_program_check.stdout | length > 0 %}
      - Configuration: {{ restart_program_check.stdout }}
      {% endif %}
  run_once: true

- name: Check for existing Start_Program parameter for Message Server
  ansible.builtin.shell: |
    grep "Start_Program" "{{ __pcs_find_ascs_sap_ascs_start_profile.stdout }}" | grep "_MS" || echo "NOT_FOUND"
  register: start_program_check
  changed_when: false
  run_once: true
  delegate_to: "{{ sap_ascs_node_name }}"
  when:
    - restart_program_check.stdout == "NOT_FOUND"
    - profile_file_stat.stat.exists

- name: Replace Start_Program with Restart_Program for Message Server if found
  ansible.builtin.lineinfile:
    path: "{{ __pcs_find_ascs_sap_ascs_start_profile.stdout }}"
    regexp: '^(Start_Program_[0-9]+ = local \$\(_MS\) pf=\$\(_PF\))$'
    line: 'Restart_Program_00 = local $(_MS) pf=$(_PF)'
    backup: yes
  run_once: true
  delegate_to: "{{ sap_ascs_node_name }}"
  when:
    - restart_program_check.stdout == "NOT_FOUND"
    - start_program_check.stdout != "NOT_FOUND"
    - start_program_check.stdout | length > 0
    - profile_file_stat.stat.exists

- name: Add _MS variable definition if not found and no Start_Program exists
  ansible.builtin.lineinfile:
    path: "{{ __pcs_find_ascs_sap_ascs_start_profile.stdout }}"
    line: "_MS = ms.sap$(SAPSYSTEMNAME)_$(INSTANCE_NAME)"
    insertafter: "^#.*Start SAP message server"
    backup: yes
  run_once: true
  delegate_to: "{{ sap_ascs_node_name }}"
  when:
    - restart_program_check.stdout == "NOT_FOUND"
    - start_program_check.stdout == "NOT_FOUND"
    - profile_file_stat.stat.exists

- name: Add Restart_Program parameter if no Start_Program exists to replace
  ansible.builtin.lineinfile:
    path: "{{ __pcs_find_ascs_sap_ascs_start_profile.stdout }}"
    line: "Restart_Program_00 = local $(_MS) pf=$(_PF)"
    insertafter: "_MS = ms.sap.*"
    backup: yes
  run_once: true
  delegate_to: "{{ sap_ascs_node_name }}"
  when:
    - restart_program_check.stdout == "NOT_FOUND"
    - start_program_check.stdout == "NOT_FOUND"
    - profile_file_stat.stat.exists

- name: Re-check for Restart_Program parameter after insertion
  ansible.builtin.shell: |
    grep "Restart_Program" "{{ __pcs_find_ascs_sap_ascs_start_profile.stdout }}" | grep "_MS" || echo "NOT_FOUND"
  register: restart_program_recheck
  changed_when: false
  run_once: true
  delegate_to: "{{ sap_ascs_node_name }}"
  when:
    - restart_program_check.stdout == "NOT_FOUND"
    - profile_file_stat.stat.exists

- name: Display Restart_Program insertion result
  ansible.builtin.debug:
    msg: |
      Restart_Program parameter configuration result:
      - Parameter was missing, auto-configuration attempted
      - Found existing Start_Program: {{ start_program_check.stdout != "NOT_FOUND" if start_program_check is defined else "SKIPPED" }}
      - Re-check result: {{ restart_program_recheck.stdout | default("SKIPPED") }}
      - Configuration successful: {{ restart_program_recheck.stdout != "NOT_FOUND" and restart_program_recheck.stdout | length > 0 }}
  run_once: true
  when: restart_program_check.stdout == "NOT_FOUND"

- name: Restart sapstartsrv service after profile modification
  ansible.builtin.systemd:
    name: "SAP{{ sap_ascs_sid }}_{{ sap_ascs_instance_number }}"
    state: restarted
  run_once: true
  delegate_to: "{{ sap_ascs_node_name }}"
  when:
    - restart_program_check.stdout == "NOT_FOUND"
    - restart_program_recheck.stdout != "NOT_FOUND"
    - restart_program_recheck.stdout | length > 0

- name: Wait for ASCS resource to show failed actions after sapstartsrv restart
  sap.sap_operations.pcs_status_info:
  register: pcs_status_post_restart
  until: "(pcs_status_post_restart.pacemaker_status['pacemaker-result'].failures | default([]) | length > 0)"
  delay: 1
  retries: 300
  run_once: true
  when:
    - restart_program_check.stdout == "NOT_FOUND"
    - restart_program_recheck.stdout != "NOT_FOUND"
    - restart_program_recheck.stdout | length > 0

- name: Display ASCS resource failure detection status
  ansible.builtin.debug:
    msg: |
      ASCS resource failure detection after sapstartsrv restart:
      - Total failures detected: {{ pcs_status_post_restart.pacemaker_status['pacemaker-result'].failures | default([]) | length }}
      - Cluster has detected failures and will handle resource recovery
  run_once: true
  when:
    - restart_program_check.stdout == "NOT_FOUND"
    - restart_program_recheck.stdout != "NOT_FOUND"
    - restart_program_recheck.stdout | length > 0
    - pcs_status_post_restart is defined

- name: Wait for ASCS resource to be fully started after cluster recovery
  sap.sap_operations.pcs_status_info:
  register: pcs_status_ascs_recovery
  until: "pcs_status_ascs_recovery | sap.sap_operations.pcs_resources_from_status(role='Started', id=sap_ascs_resource_name) | length > 0"
  delay: 1
  retries: 300
  run_once: true
  when:
    - restart_program_check.stdout == "NOT_FOUND"
    - restart_program_recheck.stdout != "NOT_FOUND"
    - restart_program_recheck.stdout | length > 0

- name: Display ASCS resource recovery status
  ansible.builtin.debug:
    msg: |
      ASCS resource recovery status:
      - ASCS resource is now started: {{ (pcs_status_ascs_recovery | sap.sap_operations.pcs_resources_from_status(role='Started', id=sap_ascs_resource_name) | length > 0) if pcs_status_ascs_recovery is defined else false }}
      - Ready to re-discover ASCS location accurately
  run_once: true
  when:
    - restart_program_check.stdout == "NOT_FOUND"
    - restart_program_recheck.stdout != "NOT_FOUND"
    - restart_program_recheck.stdout | length > 0
    - pcs_status_ascs_recovery is defined

- name: Re-discover ASCS location after sapstartsrv restart
  ansible.builtin.include_role:
    name: sap.cluster_qa.pcs_find_ascs
  when:
    - restart_program_check.stdout == "NOT_FOUND"
    - restart_program_recheck.stdout != "NOT_FOUND"
    - restart_program_recheck.stdout | length > 0

- name: Update ASCS node name after potential failover
  ansible.builtin.set_fact:
    sap_ascs_node_name_after_restart: "{{ sap_ascs_node_name }}"
  when:
    - restart_program_check.stdout == "NOT_FOUND"
    - restart_program_recheck.stdout != "NOT_FOUND"
    - restart_program_recheck.stdout | length > 0

- name: Display ASCS location status after sapstartsrv restart
  ansible.builtin.debug:
    msg: |
      ASCS location status after sapstartsrv restart:
      - Original ASCS location (before restart): {{ sap_ascs_node_name_original }}
      - ASCS location after restart: {{ sap_ascs_node_name_after_restart | default("NO_RESTART") }}
      - ASCS failover occurred: {{ (sap_ascs_node_name_original != sap_ascs_node_name_after_restart) if sap_ascs_node_name_after_restart is defined else false }}
  run_once: true
  when:
    - restart_program_check.stdout == "NOT_FOUND"
    - restart_program_recheck.stdout != "NOT_FOUND"
    - restart_program_recheck.stdout | length > 0

- name: Verify Restart_Program parameter is configured for Message Server
  ansible.builtin.assert:
    that: 
      - profile_file_stat.stat.exists
      - (restart_program_check.stdout != "NOT_FOUND" and restart_program_check.stdout | length > 0) or (restart_program_recheck.stdout | default("NOT_FOUND") != "NOT_FOUND" and restart_program_recheck.stdout | default("") | length > 0)
    fail_msg: |
      PREREQUISITE FAILED: Restart_Program parameter for Message Server not found in ASCS profile.
      Profile checked: {{ __pcs_find_ascs_sap_ascs_start_profile.stdout }}
      Profile exists: {{ profile_file_stat.stat.exists | default(false) }}
      
      Attempted to insert the parameter automatically but failed.
      Please manually configure it according to: https://help.sap.com/docs/SUPPORT_CONTENT/si/3362959619.html
      
      Expected configuration format:
      _MS = ms.sap$(SAPSYSTEMNAME)_$(INSTANCE_NAME)
      Restart_Program_00 = local $(_MS) pf=$(_PF)
      
      Or the expanded form:
      Restart_Program_00 = local ms.sapSYSTEMNAME_INSTANCENAME pf=/path/to/profile
    success_msg: |
      PREREQUISITE VERIFIED: Restart_Program parameter found for Message Server.
      Configuration: {{ restart_program_check.stdout if restart_program_check.stdout != "NOT_FOUND" else restart_program_recheck.stdout }}
      {% if sap_ascs_node_name_after_restart is defined %}
      Note: sapstartsrv was restarted after parameter insertion. ASCS location: {{ sap_ascs_node_name_after_restart }}
      {% endif %}
  run_once: true

- name: Finding ERS node name
  ansible.builtin.include_role:
    name: sap.cluster_qa.pcs_find_ers

- name: Setting initial facts
  ansible.builtin.set_fact:
    sap_ascs_node_name_initial: "{{ sap_ascs_node_name_after_restart | default(sap_ascs_node_name) }}"
    sap_ers_node_name_initial: "{{ sap_ers_node_name }}"
    message_server_kill_count: 0
    max_kill_attempts: 6
    msg_server_restarted: true

- name: Verify ASCS and ERS are on different nodes initially
  ansible.builtin.assert:
    that: sap_ascs_node_name_initial != sap_ers_node_name_initial
    fail_msg: "ASCS and ERS are on the same node initially, which violates HA setup requirements"
    success_msg: "ASCS on {{ sap_ascs_node_name_initial }}, ERS on {{ sap_ers_node_name_initial }} - proper HA setup confirmed"

- name: Execute Message Server kill attempts
  include_tasks: kill_message_server.yml
  loop: "{{ range(1, max_kill_attempts|int + 1)|list }}"
  loop_control:
    loop_var: kill_attempt
  when: msg_server_restarted | bool

- name: Wait for HA solution to respond to unrecoverable Message Server failure
  ansible.builtin.pause:
    seconds: 60
    prompt: "Waiting for HA solution to respond to repeated Message Server failures"

- name: Check final ASCS location after HA intervention
  ansible.builtin.include_role:
    name: sap.cluster_qa.pcs_find_ascs

- name: Check final ERS location
  ansible.builtin.include_role:
    name: sap.cluster_qa.pcs_find_ers

- name: Set final location facts
  ansible.builtin.set_fact:
    sap_ascs_node_name_final: "{{ sap_ascs_node_name }}"
    sap_ers_node_name_final: "{{ sap_ers_node_name }}"

- name: Verify HA solution responded appropriately
  ansible.builtin.assert:
    that:
      - sap_ascs_node_name_final != sap_ers_node_name_final
    fail_msg: "HA solution failed: ASCS and ERS ended up on the same node ({{ sap_ascs_node_name_final }})"
    success_msg: "HA solution succeeded: ASCS on {{ sap_ascs_node_name_final }}, ERS on {{ sap_ers_node_name_final }}"

- name: Display test summary
  ansible.builtin.debug:
    msg: 
      - "==============================================="
      - "              TEST09 SUMMARY"
      - "==============================================="
      - "Message Server killed: {{ message_server_kill_count }} times"
      - "Initial ASCS location: {{ sap_ascs_node_name_initial }}"
      - "Final ASCS location: {{ sap_ascs_node_name_final }}"
      - "Initial ERS location: {{ sap_ers_node_name_initial }}"
      - "Final ERS location: {{ sap_ers_node_name_final }}"
      - "HA Action taken: {{ 'ASCS Failover' if sap_ascs_node_name_initial != sap_ascs_node_name_final else 'ASCS Restart on same node' }}"
      - "ASCS/ERS separation maintained: {{ 'YES' if sap_ascs_node_name_final != sap_ers_node_name_final else 'NO' }}"
      - "==============================================="
  run_once: true