---
- name: Get current Message Server process info
  sap.sap_operations.host_info:
  register: test10_current_ascs_host_info
  when: ansible_hostname == test10_sap_ascs_node_name_initial

- name: Store current Message Server PID
  ansible.builtin.set_fact:
    test10_current_msg_server_pid: >-
      {{ (test10_msg_server_process_list | selectattr('name', 'equalto', 'msg_server') | first)['pid']
         if test10_msg_server_process_list | length > 0 else 'NO_INSTANCE' }}
    test10_ascs_instance_found: "{{ test10_ascs_instance_list | length > 0 }}"
    current_msg_server_pid: >-  # noqa: var-naming[no-role-prefix]
      {{ (test10_msg_server_process_list | selectattr('name', 'equalto', 'msg_server') | first)['pid']
         if test10_msg_server_process_list | length > 0 else 'NO_INSTANCE' }}
    ascs_instance_found: "{{ test10_ascs_instance_list | length > 0 }}"  # noqa: var-naming[no-role-prefix]
  vars:
    test10_ascs_instance_list: >-
      {{ test10_current_ascs_host_info.instances | default([]) | selectattr('mSystemNumber', 'equalto', sap_ascs_instance_number) | list | default([]) }}
    test10_msg_server_process_list: >-
      {{ (test10_ascs_instance_list | first | default({}))['ProcessList'] | default([]) | selectattr('name', 'equalto', 'msg_server') | list | default([]) }}
  when:
    - ansible_hostname == sap_ascs_node_name_initial
    - test10_current_ascs_host_info is defined
    - test10_current_ascs_host_info.instances is defined

- name: Handle case when ASCS instance not found
  ansible.builtin.set_fact:
    test10_current_msg_server_pid: "NO_INSTANCE"
    test10_ascs_instance_found: false
    current_msg_server_pid: "NO_INSTANCE"  # noqa: var-naming[no-role-prefix]
    ascs_instance_found: false  # noqa: var-naming[no-role-prefix]
  when:
    - ansible_hostname == sap_ascs_node_name_initial
    - test10_current_ascs_host_info is defined
    - (test10_current_ascs_host_info.instances | default([]) |
        selectattr('mSystemNumber', 'equalto', sap_ascs_instance_number) | list | length == 0)

- name: Display Message Server PID info before kill
  ansible.builtin.debug:
    msg: |
      Preparing to kill Message Server:
      - ASCS instance found: {{ test10_ascs_instance_found | default(false) }}
      - Current PID: {{ test10_current_msg_server_pid | default('N/A') }}
      - ASCS node: {{ test10_sap_ascs_node_name_initial }}
      {% if not (test10_ascs_instance_found | default(false)) %}
      - WARNING: ASCS instance {{ sap_ascs_instance_number }} not found in process list
      {% endif %}
  when: ansible_hostname == test10_sap_ascs_node_name_initial

- name: Killing the Message Server process
  ansible.builtin.command: "kill -9 {{ test10_current_msg_server_pid }}"
  changed_when: true
  when:
    - ansible_hostname == sap_ascs_node_name_initial
    - test10_current_msg_server_pid is defined
    - test10_current_msg_server_pid != "NO_INSTANCE"
    - test10_ascs_instance_found | default(false)

- name: Mark Message Server as killed
  ansible.builtin.set_fact:
    test10_message_server_killed: true
    message_server_killed: true  # noqa: var-naming[no-role-prefix]

- name: Display kill confirmation
  ansible.builtin.debug:
    msg: |
      âœ“ Message Server process (PID: {{ test10_current_msg_server_pid }}) has been killed.
      Waiting for HA solution to detect failure and trigger failover...
  when: ansible_hostname == test10_sap_ascs_node_name_initial

